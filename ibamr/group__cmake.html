<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IBAMR: Build System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">IBAMR
   &#160;<span id="projectnumber">IBAMR version 0.19.</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Build System</div>  </div>
</div><!--header-->
<div class="contents">

<p>Description of <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s build system.  
<a href="#details">More...</a></p>
<h1><a class="anchor" id="autotoc_md6"></a>
The CMake-based IBAMR build system</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
Introduction</h2>
<p><a class="el" href="namespaceIBAMR.html">IBAMR</a> 0.8.0 introduced a complete rewrite of its build system (that is, the set of scripts that detect <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s dependencies and then compile and install the library). The new build system requires CMake version 3.15 or newer.</p>
<p>CMake is a build system generator - i.e., unlike traditional autotools usage, users will use the <code>cmake</code> executable to generate a build system instead of relying on a prepackaged <code>configure</code> script. Hence users must have CMake installed on their computer to compile <a class="el" href="namespaceIBAMR.html">IBAMR</a>.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Advantages of the CMake build system</h2>
<p>A few things are now possible with CMake that were not possible before:</p><ol type="1">
<li><code>make install</code> works correctly.</li>
<li>In the future, <a class="el" href="namespaceIBAMR.html">IBAMR</a> will go one step further than installation and offer downloadable Mac packages.</li>
<li><a class="el" href="namespaceIBAMR.html">IBAMR</a> can now be compiled with either dynamicly or staticly linked libraries.</li>
<li><a class="el" href="namespaceIBAMR.html">IBAMR</a> now exports its targets - i.e., <a class="el" href="namespaceIBAMR.html">IBAMR</a> can be added as a dependency to your own projects with the standard <code>FIND_PACKAGE</code> CMake macro, which sets up the complete header and link interface.</li>
<li>The build system itself is much easier to maintain and modify since it is written in CMake code instead of shell and m4. Boilerplate files like <code>aclocal.m4</code> no longer exist and there is no need to rerun <code>autoreconf</code>, <code>autoheader</code>, or any other such program (CMake will do this automatically if scripts are updated).</li>
<li>The CMake build system integrates well with most IDEs.</li>
</ol>
<h2><a class="anchor" id="autotoc_md9"></a>
How to use the CMake build system</h2>
<p>By default, <a class="el" href="namespaceIBAMR.html">IBAMR</a> will compile itself with shared libraries. <em>This requires that <a class="el" href="namespaceSAMRAI.html">SAMRAI</a> be compiled with position-independent code: i.e., <a class="el" href="namespaceSAMRAI.html">SAMRAI</a> must be compiled with <code>-fPIC</code></em>. If you do not compile <a class="el" href="namespaceSAMRAI.html">SAMRAI</a> this way then you must use static libraries (see the text below on static linkage).</p>
<p>This is similar to how autotools is used with a separate build directory <code>build</code>. <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s configuration scripts expect all dependencies to have their paths provided in the standard way for CMake (i.e., we pass in the root path of the directory for things installed outside the system search path). Here, for example, <code>PETSC_ROOT</code> is typically <code>$PETSC_DIR/$PETSC_ARCH</code>. <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s configuration script looks for each package in <code>PKG_ROOT</code>, where <code>PKG</code> is the all-caps version of the name: for example, CMake will look for boost in the directory specified by <code>BOOST_ROOT</code> and for muParser in the directory specified by <code>MUPARSER_ROOT</code>.</p>
<p>Same packages have ambiguous capitalizations - <a class="el" href="namespaceIBAMR.html">IBAMR</a> expects package names to be in <code>ALL_CAPS</code> (e.g., <code>PETSC_ROOT</code> and not <code>Petsc_ROOT</code>). Some aliases are also defined, mostly so that one can use the common CMake package names during configuration:</p><ul>
<li><code>BOOST_ROOT</code> and <code>Boost_ROOT</code> are equivalent</li>
<li><code>EIGEN3_ROOT</code> and <code>Eigen3_ROOT</code> are equivalent</li>
<li><code>LIBMESH_ROOT</code> and <code>libMesh_ROOT</code> are equivalent</li>
<li><code>MUPARSER_ROOT</code> and <code>muParser_ROOT</code> are equivalent</li>
<li><code>PETSC_ROOT</code> and <code>PETSc_ROOT</code> are equivalent</li>
</ul>
<p>though inside <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s build system the <code>ALL_CAPS</code> names are used.</p>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -DCMAKE_C_FLAGS=<span class="stringliteral">&quot;-O3 -march=native&quot;</span>                     \</div>
<div class="line">      -DCMAKE_CXX_FLAGS=<span class="stringliteral">&quot;-O3 -march=native&quot;</span>                   \</div>
<div class="line">      -DCMAKE_Fortran_FLAGS=<span class="stringliteral">&quot;-O3 -march=native&quot;</span>               \</div>
<div class="line">      -DCMAKE_INSTALL_PREFIX=$HOME/Applications/ibamr         \</div>
<div class="line">      -DIBAMR_ENABLE_TESTING=OFF                              \</div>
<div class="line">      -DSAMRAI_ROOT=$HOME/Applications/samrai-2.4.4           \</div>
<div class="line">      -DLIBMESH_ROOT=$HOME/Applications/libmesh-dev           \</div>
<div class="line">      -DLIBMESH_METHOD=OPT                                    \</div>
<div class="line">      -DPETSC_ROOT=$HOME/Applications/petsc-3.13.0/x86_64-opt \</div>
<div class="line">      -DMUPARSER_ROOT=$HOME/Applications/muParser-2.3.2/      \</div>
<div class="line">      ../</div>
<div class="line">make -j6</div>
<div class="line">make -j6 install</div>
</div><!-- fragment --><p><a class="el" href="namespaceIBAMR.html">IBAMR</a> requires</p><ul>
<li>Boost,</li>
<li>Eigen3,</li>
<li>HDF5,</li>
<li>Hypre,</li>
<li>MPI,</li>
<li>muParser,</li>
<li>PETSc, and</li>
<li><a class="el" href="namespaceSAMRAI.html">SAMRAI</a>.</li>
</ul>
<p>Of these, Boost, Eigen3, and muParser are also bundled with <a class="el" href="namespaceIBAMR.html">IBAMR</a> and <a class="el" href="namespaceIBAMR.html">IBAMR</a> will build its own copies of those libraries if it cannot find working externally available versions. If you wish to use the bundled version of one of these libraries instead of one found at either system or specified search locations, then you can specify that as well by passing any of</p><ul>
<li><code>-DIBAMR_FORCE_BUNDLED_BOOST=ON</code></li>
<li><code>-DIBAMR_FORCE_BUNDLED_EIGEN3=ON</code></li>
<li><code>-DIBAMR_FORCE_BUNDLED_MUPARSER=ON</code> as options to CMake.</li>
</ul>
<p>The CMake build system will attempt to find these with default search paths and also in the directory provided by <code>PKG_ROOT</code> (i.e., for Boost, the build system will search in <code>BOOST_ROOT</code>).</p>
<p><a class="el" href="namespaceIBAMR.html">IBAMR</a>'s optional dependencies are Silo and <a class="el" href="namespacelibMesh.html">libMesh</a>. These are only searched for if a directory path is provided (i.e., by passing <code>-DSILO_ROOT=/usr/</code>). <a class="el" href="namespacelibMesh.html">libMesh</a> also requires that the caller pass <code>LIBMESH_METHOD</code> to CMake to indicate which <a class="el" href="namespacelibMesh.html">libMesh</a> variant we should use (e.g., above we use the optimized version by passing <code>OPT</code>: <code>DBG</code> and <code>DEVELOP</code> are alternative options).</p>
<p>Subsequent runs of CMake are much faster than the initial run since CMake will cache some computed values (such as the MPI configuration). If you run into problems with CMake, a good way to get out of trouble is to delete <code>CMakeCache.txt</code>, which will delete the cache, and the <code>CMakeFiles</code> directory, which contains all of the files generated by CMake. Deleting the cache is harmless - the subsequent initial configuration run will just take a few more seconds.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Working with modules</h3>
<p>If you are on a cluster then you may want to use compilers and an MPI implementation that are not installed in standard locations, but are managed with the module system. CMake requires that non-default compilers be explicitly provided. Here's an example:</p>
<div class="fragment"><div class="line">module load mvapich2_2.3.3/gcc_9.1.0</div>
<div class="line"> </div>
<div class="line">mkdir build-release</div>
<div class="line">cd build-release</div>
<div class="line"> </div>
<div class="line">export PETSC_DIR=$HOME/Applications/petsc</div>
<div class="line">export HDF5_DIR=$PETSC_DIR</div>
<div class="line">export HYPRE_DIR=$PETSC_DIR</div>
<div class="line">export SAMRAI_DIR=$HOME/Applications/samrai</div>
<div class="line"> </div>
<div class="line"># most MPI implementations also set MPI_HOME. If not, you should provide a path</div>
<div class="line"># to the directory where MPI is installed.</div>
<div class="line">cmake -DMPI_ROOT=${MPI_HOME} \</div>
<div class="line">      -DHYPRE_ROOT=${HYPRE_DIR} \</div>
<div class="line">      -DHDF5_ROOT=${HDF5_DIR} \</div>
<div class="line">      -DSAMRAI_ROOT=${SAMRAI_DIR} \</div>
<div class="line">      -DPETSC_ROOT=${PETSC_DIR} \</div>
<div class="line">      -DCMAKE_CXX_COMPILER=$(which g++) \</div>
<div class="line">      -DCMAKE_C_COMPILER=$(which gcc) \</div>
<div class="line">      -DCMAKE_Fortran_COMPILER=$(which gfortran) \</div>
<div class="line">      -DCMAKE_BUILD_TYPE=Release \</div>
<div class="line">      ..</div>
<div class="line"> </div>
<div class="line">      make -j8</div>
</div><!-- fragment --><p>In particular, to use compilers specified by modules, you need to provide paths to them to CMake.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Configuring the build</h3>
<ul>
<li>If you want to build <a class="el" href="namespaceIBAMR.html">IBAMR</a> with static libraries then pass the argument <code>-DBUILD_SHARED_LIBS=OFF</code> to the initial call to <code>cmake</code>. <a class="el" href="namespaceIBAMR.html">IBAMR</a> defaults to building shared libraries.</li>
<li>At the current time the build system does not support compiling with CMake's own debug or release modes since this is not compatible with the way things were done with the autotools based build system. If you want to compile a debug build or an optimized build you will have to provide the flags yourself, like what was done at the top of the previous section.</li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
Debugging configuration issues</h2>
<ul>
<li>If you need to change a parameter passed to CMake and things don't work then try deleting the <code>CMakeCache.txt</code> file.</li>
<li>If CMake cannot find your MPI implementation then try explicitly passing in the MPI compiler wrappers - e.g., <div class="fragment"><div class="line">cmake -DCMAKE_C_COMPILER=/path/to/mpicc \</div>
<div class="line">      -DCMAKE_CXX_COMPILER=/path/to/mpicxx \</div>
<div class="line">      -DCMAKE_Fortran_COMPILER=/path/to/mpifort \</div>
<div class="line">      -DPETSC_ROOT=/path/to/petsc</div>
<div class="line"># etc.</div>
</div><!-- fragment --></li>
<li>If things don't seem to work then post a message on the <a class="el" href="namespaceIBAMR.html">IBAMR</a> mailing list.</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
How to use IBAMR in your own project</h2>
<p>If you have installed <a class="el" href="namespaceIBAMR.html">IBAMR</a> correctly then it is easy to add it as a dependency to your own project using standard CMake tools. You can configure your project (here assumed to consist of a single file, <code>main.cpp</code>, which will be compiled in 2D) with the following <code>CMakeLists.txt</code> script: </p><div class="fragment"><div class="line">PROJECT(main2d)</div>
<div class="line">CMAKE_MINIMUM_REQUIRED(VERSION 3.15.0)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># List your source files here - this example has just one.</span></div>
<div class="line">SET(SOURCE_FILES main.cpp)</div>
<div class="line">ADD_EXECUTABLE(main2d ${SOURCE_FILES})</div>
<div class="line"> </div>
<div class="line">FIND_PACKAGE(<a class="code" href="namespaceIBAMR.html">IBAMR</a> 0.10.0 REQUIRED)</div>
<div class="line">TARGET_LINK_LIBRARIES(main2d IBAMR::IBAMR2d)</div>
<div class="line"><span class="preprocessor"># IBAMR saves the flags it used to compile - you can reuse them if you want to</span></div>
<div class="line"><span class="preprocessor">SET(CMAKE_CXX_FLAGS ${IBAMR_CXX_FLAGS})</span></div>
</div><!-- fragment --><p>Run cmake as </p><div class="fragment"><div class="line">cmake -DIBAMR_ROOT=/path/to/ibamr/installation ./</div>
</div><!-- fragment --><p>where <code>/path/to/ibamr/installation</code> should be replaced by the directory path (either relative or absolute) to the installation location of <a class="el" href="namespaceIBAMR.html">IBAMR</a> or <a class="el" href="namespaceIBAMR.html">IBAMR</a>'s build directory.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Build system internals</h2>
<h3><a class="anchor" id="autotoc_md15"></a>
General setup</h3>
<p><a class="el" href="namespaceIBAMR.html">IBAMR</a> is compiled as four libraries: 2D and 3D <a class="el" href="namespaceIBTK.html">IBTK</a> libraries and 2D and 3D <a class="el" href="namespaceIBAMR.html">IBAMR</a> libraries. Since <a class="el" href="namespaceIBAMR.html">IBAMR</a> depends on <a class="el" href="namespaceIBTK.html">IBTK</a>, many features in the library are actually set up for <a class="el" href="namespaceIBTK.html">IBTK</a> and then copied into <a class="el" href="namespaceIBAMR.html">IBAMR</a> proper. <a class="el" href="namespaceIBAMR.html">IBAMR</a> and <a class="el" href="namespaceIBTK.html">IBTK</a> have their dependencies configured in the top-level <code>CMakeLists.txt</code> file. Source files for each library are listed in <code>src/CMakeLists.txt</code> and <code>ibtk/src/CMakeLists.txt</code>, respectively. Similarly, all test executables are compiled in <code>tests/CMakeLists.txt</code>.</p>
<p>Since there is a wide variety of necessary setup for examples, <a class="el" href="namespaceIBAMR.html">IBAMR</a> includes the macro <code>IBAMR_ADD_EXAMPLE</code> (defined in <code>examples/CMakeLists.txt</code>) which is used to set up a single example program (which may have multiple source and input files). New examples should use this macro as well.</p>
<h3><a class="anchor" id="autotoc_md16"></a>
Configuration headers</h3>
<p><a class="el" href="namespaceIBAMR.html">IBAMR</a> generates a single configuration header: <code><a class="el" href="build_2ibtk_2include_2ibtk_2config_8h.html">ibtk/config.h</a></code>. All macros defined in this file with the prefix <code>IBTK_</code> are redefined in <code><a class="el" href="include_2ibamr_2config_8h.html">ibamr/config.h</a></code> with the prefix <code>IBAMR_</code>. The old top-level configuration files <code>IBAMR_config.h</code> and <code>IBTK_config.h</code> do not have equivalents in the CMake build system.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Tips and Tricks</h2>
<p>cmake supports many useful features. We recommend</p><ol type="1">
<li>Use ninja instead of make for much better build performance by providing the <code>-GNinja</code> to cmake.</li>
<li>Cache object files (and thus make recompilation much faster) with <code>ccache</code> with the flag <code>-DCMAKE_CXX_COMPILER_LAUNCHER="$(which ccache)"</code>. </li>
</ol>
</div><!-- contents -->
<div class="ttc" id="anamespaceIBAMR_html"><div class="ttname"><a href="namespaceIBAMR.html">IBAMR</a></div><div class="ttdef"><b>Definition:</b> AdvDiffCenteredConvectiveOperator.h:27</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
